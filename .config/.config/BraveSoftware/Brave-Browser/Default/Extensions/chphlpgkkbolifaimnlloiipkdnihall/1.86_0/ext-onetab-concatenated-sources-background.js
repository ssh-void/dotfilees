// Copyright 2024 OneTab Ltd.  All rights reserved.
const wt="1.86",ge=!1,Se=!1,Me=!1,Ge=!1,Ie=!1,We=!1,Ae=!0,ut="chrome://",y="chrome://newtab/",gt="https://www.one-tab.com",Oe=!1,Pe=!1,Ee=!1,u=chrome.runtime.getURL("onetab.html"),N=u.substring(0,u.length-"onetab.html".length);let ct=!0;async function Y(){return ct?(await chrome.permissions.getAll()).permissions.includes("tabGroups")&&chrome.tabGroups:!1}async function St(){if(!ct)return!1;try{return await chrome.permissions.request({permissions:["tabGroups"]})}catch(i){return console.log('chrome.permissions.request for "tabGroups" permission failed with error:'),console.log(i),!1}}function Ce(i){let t=$(i);return t.toLowerCase().startsWith("www.")?t.substring("www.".length):t}function $(i){return i?(i.indexOf("//")===0&&(i="http:"+i),i.indexOf("://")===-1&&(i="http://"+i),i=i.substring(i.indexOf("://")+"://".length),i.indexOf("/")!==-1&&(i=i.substring(0,i.indexOf("/"))),i.indexOf(":")!==-1&&(i=i.substring(0,i.indexOf(":"))),i.indexOf("?")!==-1&&(i=i.substring(0,i.indexOf("?"))),i.indexOf("#")!==-1&&(i=i.substring(0,i.indexOf("#"))),i.toLowerCase()):"undefined"}function ke(i){return i.indexOf("://")===-1?"https://":(i=i.substring(0,i.indexOf("://")+"://".length),i.toLowerCase())}let Mt=["com","co.uk","org.uk","net","org","de","ru","info","xyz","nl"];function Fe(i){let t=$(i);try{for(let e in Mt){let a="."+Mt[e];if(Kt(t,a)){for(t=t.substring(0,t.length-a.length);t.indexOf(".")!==-1;)t=t.substring(t.indexOf(".")+1);t=t+a;break}}return t.indexOf("www.")===0&&(t=t.substring("www.".length)),t}catch{return t}}function Ut(i){i.noCacheRandom=Nt()}function Nt(){return new Date().getTime()+Math.round(Math.random()*1e4)+""}async function $t(i,t){Ut(t);let e=JSON.stringify(t);return await(await jt(i,e)).json()}async function jt(i,t){let e={};t?(e.method="POST",e.body=t):e.method="GET",e.headers=new Headers,e.headers.append("Content-Type","text/json");let a=await fetch(i,e);if(a.status===200)return a;throw new Error("http response code"+a.status)}function Jt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{let t=Math.random()*16|0;return(i=="x"?t:t&3|8).toString(16)})}const Ht="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");function X(i,t){let e=Ht,a=[],s=0;for(t=t||e.length,i=i||22,s=0;s<i;s++)a[s]=e[0|Math.random()*t];return a.join("")}function F(){return X()}function qt(){return F()}function De(i){return i==null?"":i.replace(/^\s+/,"").replace(/\s+$/,"")}function Vt(...i){return(t,e)=>i.reduce((a,s)=>a||s(t,e),0)}function Re(i){return(t,e)=>i(t)-i(e)}function dt(i){return(t,e)=>i(e)-i(t)}const ht=(i,t)=>!!t.starred-!!i.starred||i.starred&&t.starred&&t.starredDate-i.starredDate||t.createDate-i.createDate;function Z(i){return i||(i=""),i.replace(/[\x00-\x1F\x7F-\x9F]/g,"")}function Kt(i,t){return i?i.indexOf(t,i.length-t.length)!==-1:!1}const zt={restoreWindow:"newWindow",pinnedTabs:"ignore",startupLaunch:"displayOneTab",restoreRemoval:"default",duplicates:"allow",pinned:"true"};function E(i,t){return t[i]?t[i]:zt[i]}function Be(i,t,e){i.parentNode&&i.remove(),t.insertBefore(i,e===void 0||e>=t.children.length||t.children.length===0?null:t.children[Math.max(0,e)])}function ve(i,t,e){let a=t===void 0?i:document.createElement(t),s={};if(e){e.style&&Object.assign(a.style,e.style);for(let n of Object.keys(e))n!=="style"&&n!=="children"&&(a[n]=e[n]);if(e.children)for(const[n,l]of Object.entries(e.children))s[n]=l,a.appendChild(l instanceof HTMLElement?l:l.o);e.l&&a.appendChild(e.l),e.init&&e.init(a)}t!==void 0&&i&&i.appendChild(a);let r={o:a};return Object.assign(r,s),r}const Gt="about:reader?url=";function I(i){return i?i.indexOf(":")===-1?"https://"+i:i.indexOf(Gt)===0?decodeURIComponent(i.substring(Gt.length)):i.startsWith(`${N}placeholder.html?`)?new URLSearchParams(i.substring(i.indexOf("?"))).get("url"):i:""}function Le(i){return parseInt(i.match(/\d+/)[0])}const It=[...new Array(30)].map((i,t)=>parseInt(10+Math.pow(1.6,t)));function*bt(i){let t=0;for(;It.slice(0,t).reduce((e,a)=>e+a,0)<i;)yield It[t++]}async function Wt(i,t,e){let a=0;for(let s of bt(i)){if(await e(a))return;await d(s),a+=s}throw new Error(`Timeout waiting for condition ${t}`)}function x(i){let t=chrome.i18n.getMessage(i);return t||(console.log("No translation available for: "+i),i)}function V(i,t,e){return t&&((i||"").toLowerCase().startsWith("file:")||tt(i))?e?`data:text/html, <html><body><div id="placeholderUrl">${i}</div></body></html>`:`${N}placeholder.html?url=${encodeURI(i)}`:i}async function _(){try{return!await chrome.extension.isAllowedFileSchemeAccess()}catch(i){return console.log(i),!0}}function tt(i){for(let t of Qt)if(i.startsWith(t))return!0;return!!(!i||i===""||i.startsWith("chrome-devtools:"))}const Qt=["javascript:","about:",...["chrome://","edge://","data:"].filter(i=>!1),...["edge://","chrome://"].map(i=>["newtab","new-tab-page","print","network-error","badcastcrash","inducebrowsercrashforrealz","crash","crashdump","kill","hang","shorthang","gpuclean","gpucrash","gpuhang","memory-exhaust","memory-pressure-critical","memory-pressure-moderate","ppapiflashcrash","ppapiflashhang","quit","restart"].map(t=>`${i}${t}/`)).flat()];async function d(i){return new Promise(t=>setTimeout(t,i))}class Yt{async put(t,e){await chrome.storage.local.set({[t]:e})}async get(t){return(await chrome.storage.local.get([t]))[t]}async remove(t){return await chrome.storage.local.remove(t)}}const Xt=new Yt;function g(){return Xt}const Zt="undefined-34LKmiHxP3Mu48u8qrDaHf";function ft(i,t,e){return Array.isArray(i)?i.map(a=>ft(a,t,e)):typeof i=="object"&&i!==null?Object.fromEntries(Object.entries(i).map(([a,s])=>[a,ft(s,t,e)])):i===t?e:i}const k="c",P="e",R="t";class _t{async put(t,e){await chrome.storage.session.set({[t]:e})}async get(t){return(await chrome.storage.session.get([t]))[t]}async getAll(){return await chrome.storage.session.get(null)}async remove(t){return await chrome.storage.session.remove(t)}async clearAll(){await chrome.storage.session.clear()}}class te{async put(t,e){await g().put("sessionStore",{...await this.getAll(),[t]:e})}async get(t){return(await this.getAll())[t]}async getAll(){return await g().get("sessionStore")??{}}async remove(t){let e=await this.getAll();delete e[t],await g().put("sessionStore",e)}async clearAll(){await g().remove("sessionStore")}}const ee=chrome.storage.session?new _t:new te;function S(){return ee}function At(){return navigator.userAgent.includes(" Edg/")}async function Ot(i){let[t]=await chrome.tabs.query({windowId:i.windowId,active:!0});t&&t.id!==i.id?(await chrome.tabs.update(i.id,{active:!0}),await chrome.tabs.update(t.id,{active:!0})):console.log("No active tab found")}class et{constructor(t={}){this.yt=[],this.locked=!1,this.debug=!1,this.It=t}async Pt(){if(this.debug&&console.log(`lock ${this.It.label}: begin acquire attempt, queue len: ${this.yt.length}`),this.locked){if(this.debug&&console.log(`lock ${this.It.label}: waiting to acquire, queue len: ${this.yt.length}`),this.It.Ca)for(this.debug&&this.yt.length>0&&console.log(`lock ${this.It.label}: rejecting ${this.yt.length} queuers`);this.yt.length>0;)this.yt.shift().resolve(!1);let t=await new Promise((e,a)=>{this.yt.push({resolve:e,reject:a})});return this.debug&&(t?console.log(`lock ${this.It.label}: acquired after waiting, queue len: ${this.yt.length}`):console.log(`lock ${this.It.label}: acquisition rejected`)),t}else return this.locked=!0,this.debug&&console.log(`lock ${this.It.label}: acquired, queue len: ${this.yt.length}`),!0}release(){this.debug&&console.log(`lock ${this.It.label}: begin release, queue len: ${this.yt.length}`),this.yt.length===0?this.locked=!1:(this.yt.shift().resolve(!0),this.debug&&console.log(`lock ${this.It.label}: waiting thread notified. queue len: ${this.yt.length}`)),this.debug&&console.log(`lock ${this.It.label}: released. queue len: ${this.yt.length}`)}}class v{static ue=6e4;static getKey(t){return`sessionStoreLock-${t}`}static async Ce(t){let e=await S().get(v.getKey(t)),a=new Date().getTime();return e&&a-e>v.ue&&(console.log(`Warning: timed out sessionStore lock for id ${t}`),await v.release(t)),!!(e&&a-e<v.ue)}static async Pt(t){return await this.Ce(t)?!1:(await S().put(v.getKey(t),new Date().getTime()),!0)}static async release(t){await S().remove(v.getKey(t))}}class L{constructor(){this.ke=[],this.ce=new et({label:"openOneTabOnStartLock"}),this.de=new et({label:"duplicateCheck"}),this.he=new et({label:"stateLock"}),this.Et=new et({label:"settingsLock"})}async corePing(){return{pong:String(wt)}}async Fe(){await this.Et.Pt();try{let t=await g().get("extensionKey");return t||(t=Jt(),await g().put("extensionKey",t)),t}finally{this.Et.release()}}async Kt(t){let e=await at(!1);for(let a=0;a<e.length;a++)await this.Rt({Bt:e[a],vt:!0,Lt:t,Z:a===0})}async kt(t){let e=ce(t),a=!0;if(0)try{}catch(l){}let s=await M(),r=s.filter(l=>[l.url,l.pendingUrl].some(w=>w===e)),n=r.length>0?r[0]:void 0;r.length>1&&r.filter(l=>l!==n).forEach(l=>W(l)),n?(a&&ne(n),n=s.find(l=>[l.url,l.pendingUrl].some(w=>w===e)),await B(n)):await it(e,!1,!0)}async be(t,e){let a=await _(),s=await Y(),r=s&&t.groupType==="tabGroup",n=t.tabsMeta.filter(m=>!tt(m.url)),l=await this.getSettings(),w=E("restoreWindow",l);e==="currentWindow"&&(w="currentWindow"),e==="newWindow"&&(w="newWindow");let h=(await j()).tabs.filter(m=>!(m.pinned||G(m.url)||ae(m.url))).length,T=[],p;if(w==="currentWindow"||w==="newWindow"&&e!=="newWindow"&&h===0){p=await J(!1);for(const[m,b]of n.entries()){let f={active:!1,url:V(b.url,a)};p!==void 0&&(f.windowId=p.id),f.pinned=!r&&!!b.pinned;try{let O=await D(f);T.push(O)}catch(O){console.log(O)}}}else{let{zt:m,Qt:b}=await pt(n.map(f=>({...f,pinned:!r&&f.pinned})));p=m,T.push(...b)}if(r){let m=await chrome.tabs.group({createProperties:{windowId:p.id},tabIds:T.map(f=>f.id)}),b={};t.color&&(b.color=t.color),t.label&&(b.title=t.label),Object.keys(b).length>0&&s&&await chrome.tabGroups.update(m,b)}await this.De()}async K(t){let e=await this.getState(),a=t.split(`
`),s=new Date().getTime(),r=()=>({createDate:s--,tabsMeta:[],id:X()}),n=r(),l=[];for(let h of a)if(!h)n.tabsMeta.length>0&&(l.push(n),n=r());else{let T,p;h.indexOf(" | ")!==-1?(T=I(h.substring(0,h.indexOf(" | "))),p=h.substring(h.indexOf(" | ")+" | ".length)):(T=I(h),p=$(T)),n.tabsMeta.push({id:F(),url:T,title:Z(p)})}n.tabsMeta.length>0&&l.push(n);let w=Math.max(0,e.tabGroups.findIndex(h=>!h.starred)),c=l.map((h,T)=>({type:"createTabGroup",tabGroupId:h.id,tabGroup:h,index:w+T}));for(let h of c)await this.St(h)}async St(t,e){await this.he.Pt();try{let a=await this.getState();if(t.type==="createTabGroup")e?a.tabGroups.splice(a.tabGroups.findIndex(s=>s.id===t.tabGroupId),1):a.tabGroups.splice(t.index,0,t.tabGroup);else if(t.type==="createTabs"){let s=a.tabGroups.find(r=>r.id===t.tabGroupId);if(!e)s.tabsMeta.unshift(...t.newTabsMeta);else{let r=new Set(t.newTabsMeta.map(n=>n.id));s.tabsMeta=s.tabsMeta.filter(n=>!r.has(n.id))}}else if(t.type==="deleteTabs"){let s=a.tabGroups.find(r=>r.id===t.tabGroupId);if(e){let r=[];t.tabsMetaDeleted.forEach((n,l)=>r.push([n,t.tabIndicesDeleted[l]])),r.sort((n,l)=>n[1]-l[1]),r.forEach(([n,l])=>s.tabsMeta.splice(l,0,n))}else{let r=new Set(t.tabMetaIds);s.tabsMeta=s.tabsMeta.filter(n=>!r.has(n.id))}}else if(t.type==="deleteTabGroup")if(e)a.tabGroups.splice(Math.max(0,t.index),0,t.deletedTabGroup);else{let s=a.tabGroups.findIndex(r=>r.id===t.tabGroupId);a.tabGroups.splice(s,1)}else if(t.type==="updateTabGroup"){let s=e?"old":"new",r=e?"new":"old",n=a.tabGroups,l=n.find(c=>c.id===t.tabGroupId),w=t.propChanges;w.starred&&(l.starred=w.starred[s],l.starredDate=w.starredDate[s]),w.label&&(l.label=w.label[s]),w.locked&&(l.locked=w.locked[s]),w.groupType&&(l.groupType=w.groupType[s]),w.index&&n.splice(w.index[s],0,...n.splice(w.index[r],1))}else if(t.type==="reorderTab"){let s=a.tabGroups.find(w=>w.id===t.tabGroupId),r=s.tabsMeta.findIndex(w=>w.id===t.tabMetaId),n=s.tabsMeta[r],l=t.newIndex;e&&(l=r,r=t.newIndex),s.tabsMeta.splice(r,1),s.tabsMeta.splice(Math.min(l,s.tabsMeta.length),0,n)}else if(t.type==="moveTabBetweenTabGroups"){let s=a.tabGroups.findIndex(l=>l.id===t.sourceTabGroupId),r=a.tabGroups[s],n=a.tabGroups.find(l=>l.id===t.targetTabGroupId);if(e){let l=n.tabsMeta.findIndex(c=>c.id===t.tabMetaId),w=n.tabsMeta.splice(l,1)[0];t.deletedSourceTabGroup?a.tabGroups=a.tabGroups.splice(t.sourceTabGroupIndex,0,t.deletedSourceTabGroup):r.splice(t.sourceTabGroupTabIndex,0,w)}else{let l=r.tabsMeta.findIndex(c=>c.id===t.tabMetaId),w=r.tabsMeta.splice(l,1)[0];n.tabsMeta.splice(t.targetTabGroupTabIndex,0,w),t.deletedSourceTabGroup&&(a.tabGroups=a.tabGroups.filter(c=>c.id!==t.deletedSourceTabGroup.id))}}await this.Ut(a),await this.Re(t,e)}finally{this.he.release()}}async Be(){let t=await this.getState(),e=[],a=new Date().getTime();for(let n=0;n<200;n++){let l={createDate:a--,tabsMeta:[],label:"tab group "+n,id:X()};e.push(l);for(let w=0;w<20;w++)l.tabsMeta.push({id:F(),url:"https://en.wikipedia.org/wiki/"+(20*n+w),title:"wikipedia "+(20*n+w)})}let s=Math.max(0,t.tabGroups.findIndex(n=>!n.starred)),r=e.map((n,l)=>({type:"createTabGroup",tabGroupId:n.id,tabGroup:n,index:s+l}));for(let n of r)await this.St(n);await this.Z()}async De(){if((await o.fe())?.pinned)return;if((await this.getState()).tabGroups.map(a=>a.tabsMeta.length).reduce((a,s)=>a+s,0)===0){let s=(await M()).find(r=>G(r.url));s&&await W(s)}}async getSettings(){let t=await g().get("settings");return t?JSON.parse(t):{}}async ft(t,e){await this.Et.Pt();try{let a=await this.getSettings();a[t]=e,await this.se(a)}finally{this.Et.release()}}async se(t){await g().put("settings",JSON.stringify(t))}async ve(t){let e=await this.getSettings();return E(t,e)}async getState(){let t=await g().get("state");return t?JSON.parse(t):{}}async Ut(t){await this.Te(t);let e=await g().get("state"),a=e;await g().put("state",JSON.stringify(t)),e=await g().get("state");try{JSON.parse(e)}catch{await g().put("state",a),console.log("Could not store extension state")}finally{}}async pe(t,e,a){let s={id:F(),url:I(t),title:Z(e)};await this.me(s,a)}async Le(t,e){if(G(t.url))return;let a={id:F(),url:I(t.url),title:Z(t.title)};["pinned","incognito"].filter(s=>t[s]).forEach(s=>a[s]=t[s]),await this.me(a,e),await W(t)}async me(t,e){if(t={...t},t.url=I(t.url),tt(t.url)){console.log(`Cannot import tabs of this type: ${t.url}`);return}let a=await this.getState();if(e===void 0){let s=a.tabGroups.find(r=>!r.starred&&!r.locked);if(s)await this.St({type:"createTabs",tabGroupId:s.id,newTabsMeta:[t]});else{s={id:F(),tabsMeta:[t],createDate:new Date().getTime()};let r=Math.max(0,a.tabGroups.findIndex(n=>!n.starred));await this.St({type:"createTabGroup",tabGroupId:s.id,tabGroup:s,index:r})}}else await this.St({type:"createTabs",tabGroupId:e,newTabsMeta:[t]})}Ft(t,e,a){return t.pinned&&E("pinnedTabs",a)==="ignore"||G(e)||e.indexOf("chrome-devtools://")===0}Ue(t,e,a){return ie(e)&&!G(e)||tt(e)||E("duplicates",a)==="reject"&&t.tabGroups.some(s=>s.tabsMeta.some(r=>I(r.url)===e))}async Rt({Bt:t,vt:e,Lt:a,Z:s}){if(!t.length)return;const r=Symbol();let n=await Y(),l=n?await chrome.tabGroups.query({windowId:t[0].windowId}):[],w=await this.getSettings(),c=await this.getState(),h=new Set((await M()).map(b=>b.id)),T=t.filter(b=>h.has(b.id)&&(!e||!this.ye(I(b.url),w)));T.sort((b,f)=>b.index-f.index);let p=[],m=[];for(let b of T){let f=b.url;!f&&b.pendingUrl&&(f=b.pendingUrl);let O=I(f);if(!this.Ft(b,O,w)){m.push(b);let q=p.find(U=>U[r]===b.groupId);if(!this.Ue(c,O,w)&&!(q?.tabsMeta??[]).some(U=>U.url===O)){let U={id:F(),url:O,title:Z(b.title)};if(b.pinned&&(U.pinned=!0),!q){let lt=n&&b.groupId!==chrome.tabGroups.TAB_GROUP_ID_NONE&&l.find(Lt=>Lt.id===b.groupId);q={[r]:b.groupId,id:F(),tabsMeta:[],createDate:new Date().getTime(),...lt?{groupType:"tabGroup",color:lt.color,label:lt.title}:{}},p.push(q)}q.tabsMeta.push(U)}}}for(let b of p)delete b[r];if(p.length)if(a===void 0){let b=Math.max(0,c.tabGroups.findIndex(O=>!O.starred)),f=0;for(let O of p)await this.St({type:"createTabGroup",tabGroupId:O.id,tabGroup:O,index:b+f++})}else{let b=p.flatMap(f=>f.tabsMeta);await this.St({type:"createTabs",tabGroupId:a,newTabsMeta:b})}m.length===0?await o.Z(!1,void 0):await oe(m,s)}ye(t,e){return this.Yt($(t),e)}Yt(t,e){if(e.excludedDomains){for(let a of e.excludedDomains)if(a===t)return!0}return!1}async xe(t){await this.Et.Pt();try{let e=await this.getSettings();this.Yt(t,e)||(e.excludedDomains||(e.excludedDomains=[]),e.excludedDomains.push(t),await this.se(e))}finally{this.Et.release()}}async ne(t){await this.Et.Pt();try{let e=await this.getSettings();if(!e.excludedDomains)return;e.excludedDomains=e.excludedDomains.filter(a=>a!==t),await this.se(e)}finally{this.Et.release()}}async Te(t){let e=!1;return t.tabGroups.forEach(a=>{a.tabsMeta&&a.tabsMeta.some(s=>!s)&&(a.tabsMeta=a.tabsMeta.filter(s=>s),e=!0)}),t.tabGroups.some(a=>!a.tabsMeta||!a.tabsMeta.length)&&(e=!0,t.tabGroups=t.tabGroups.filter(a=>a.tabsMeta&&a.tabsMeta.length)),e&&console.log("State fixed"),e}async Ne(){await g().get("installDate")||await g().put("installDate",new Date().getTime());let e=await this.getState();e.tabGroups||(e.tabGroups=[],await this.Ut(e)),await this.Te(e)&&await this.Ut(e),[...e.tabGroups].sort(ht).every((a,s)=>a===e.tabGroups[s])||(console.log("Tabgroups correctly reordered"),e.tabGroups.sort(ht),await this.Ut(e))}async $e(t){t&&(await chrome.windows.get(t))?.incognito&&(t=void 0),await this.Z(!1,t)}async re(t,e){let{activeTab:a}=await K(e?.windowId);await this.Le(a,t)}async je(t,e,a){let r=t.linkUrl,n=t.frameId,l=n!==void 0?[n]:[],w=t.linkTitle;if(w||(w=t.linkText),w)await this.pe(r,w,a);else{await chrome.scripting.executeScript({target:{tabId:e.id,frameIds:l},files:["ext-onetab-concatenated-sources-contentscript.js"]});let c=await new Promise((T,p)=>{chrome.tabs.sendMessage(e.id,{type:"getLinkTitle",url:r},{frameId:n},m=>{chrome.runtime.lastError?p(chrome.runtime.lastError.message):T(m.title)})});await this.pe(r,c,a);let h="Pbclevtug BarGno Ygq jjj.bar-gno.pbz"}}async Wt(t,e){let{tabs:a,activeTab:s}=await K(e?.windowId),r=a.filter(n=>n.groupId===s.groupId);if(r.length===1&&G(s.url)){let n=a.find(l=>l.groupId!==s.groupId);n&&(r=a.filter(l=>l.groupId===n.groupId))}await this.Rt({Bt:r,vt:!0,Lt:t,Z:!0})}async ge(t,e){let{tabs:a,activeTab:s}=await K(e?.windowId);a=a.filter(n=>n.groupId===s.groupId);let r=[];if(s){for(let n of a)parseInt(n.index)!==parseInt(s.index)&&r.push(n);r.length>0&&await this.Rt({Bt:r,vt:!0,Lt:t,Z:!1})}else console.log("no active tab")}async Se(t,e){let{tabs:a,activeTab:s}=await K(e?.windowId);a=a.filter(n=>n.groupId===s.groupId);let r=[];if(s){for(let n of a)parseInt(n.index)<parseInt(s.index)&&r.push(n);r.length>0&&await this.Rt({Bt:r,vt:!0,Lt:t,Z:!1})}}async Me(t,e){let{tabs:a,activeTab:s}=await K(e?.windowId);a=a.filter(n=>n.groupId===s.groupId);let r=[];if(s){for(let n of a)parseInt(n.index)>parseInt(s.index)&&r.push(n);r.length>0&&await this.Rt({Bt:r,vt:!0,Lt:t,Z:!1})}}async Mt(){return await o.ve("pinned")==="true"}async ka(t){await this.de.Pt();try{if(await mt(t)===void 0)return!1;let a=(await M()).filter(r=>G(r.url)&&r.id!==t),s;if(s=a,await Promise.all(s.slice(1).map(r=>Tt(r.id))),s.length){let r=s[0];return await B(r),await nt(r.id),await Tt(t),!0}else return await nt(t),!1}catch(e){return console.log(e),!1}finally{this.de.release()}}async Z(t,e){let a=!t,s=await M(),r=await J(!1),n=s.filter(l=>[l.url,l.pendingUrl].some(w=>G(w))).sort(Vt(dt(l=>l.windowId===e),dt(l=>!!l.active),...r&&!r?.incognito?[dt(l=>l.windowId===r.id)]:[])).find(()=>!0);if(n)await Promise.all(s.filter(l=>!(l.pinned&&!1)&&[l.url,l.pendingUrl].some(w=>G(w))&&l.id!==n.id).map(l=>W(l))),a&&await B(n);else{let l={url:u,...await this.Mt()?{pinned:!0,index:0}:{},active:a},w=!1;if(e!==void 0)l.windowId=e;else{let c=r;if(c?.incognito&&(c=(await C(!1)).find(h=>!h.incognito)),c)l.windowId=c.id;else{w=!0;let h=await Ct({});if(h?.id){let T=await S().get("lastCreateNewWindowTrigger");T&&new Date().getTime()-T<5e3||(await S().put("lastCreateNewWindowTrigger",new Date().getTime()),await this.Z(t,h.id))}}}w||await D(l)}}static Nt(t,e,a,s){t[e]={old:a[e],new:s[e]}}async Fa(t,e){let s=(await this.getState()).tabGroups,r=s.find(w=>w.id===t),n={},l=!1;if(e.hasOwnProperty("starred")&&(L.Nt(n,"starred",r,e),L.Nt(n,"starredDate",r,e)),e.hasOwnProperty("label")&&(L.Nt(n,"label",r,e),l=!0),e.hasOwnProperty("locked")&&L.Nt(n,"locked",r,e),e.hasOwnProperty("groupType")&&L.Nt(n,"groupType",r,e),e.hasOwnProperty("starred")){r.starred=e.starred,r.starredDate=e.starredDate;let w=s.findIndex(h=>h.id===t),c=[...s].sort(ht).findIndex(h=>h.id===t);n.index={old:w,new:c}}await this.St({type:"updateTabGroup",tabGroupId:t,propChanges:n}),l&&H()}async Da(t,e){let s=(await this.getState()).tabGroups,r=s.findIndex(T=>T.id===t),n=s[r],l=JSON.parse(JSON.stringify(n)),w=n.tabsMeta.find(T=>T.id===e),c=n.tabsMeta.findIndex(T=>T.id===e);n.tabsMeta.length===1&&n.tabsMeta[0].id===e?(await this.St({type:"deleteTabGroup",tabGroupId:n.id,deletedTabGroup:l,index:r}),n.label&&H()):await this.St({type:"deleteTabs",tabGroupId:n.id,tabMetaIds:[e],tabsMetaDeleted:[w],tabIndicesDeleted:[c]})}async Ra(t,e,a){let s=await this.getState(),r=s.tabGroups.findIndex(l=>l.id===t),n=s.tabGroups[r];await this.St({type:"deleteTabGroup",tabGroupId:n.id,deletedTabGroup:n,index:r}),n.label&&H(),e&&await this.be(n,a)}async Ba(t,e,a){let r=(await this.getState()).tabGroups.find(c=>c.id===t),n=r.tabsMeta.findIndex(c=>c.id===e),l=r.tabsMeta[n],w;a!==void 0?w=r.tabsMeta.filter(c=>c.id!==e).findIndex(c=>c.id===a):w=Math.max(0,r.tabsMeta.length-1),await this.St({type:"reorderTab",tabMetaId:l.id,tabGroupId:r.id,oldIndex:n,newIndex:w})}async va(t,e,a,s){let r=await this.getState(),n=r.tabGroups.findIndex(b=>b.id===t),l=r.tabGroups[n],w=JSON.parse(JSON.stringify(l)),c=l.tabsMeta.findIndex(b=>b.id===a),h=r.tabGroups.find(b=>b.id===e),T;s!==void 0?T=h.tabsMeta.findIndex(b=>b.id===s):T=h.tabsMeta.length;let p=l.tabsMeta.length===1&&l.tabsMeta[0].id===a,m={type:"moveTabBetweenTabGroups",tabMetaId:a,sourceTabGroupId:l.id,targetTabGroupId:h.id,sourceTabGroupTabIndex:c,targetTabGroupTabIndex:T,sourceTabGroupIndex:n};p&&(m.deletedSourceTabGroup=w),await this.St(m),p&&l.label&&H()}La(t){this.ke=[t]}async fe(){return(await chrome.tabs.query({})).find(t=>t.url?.startsWith(u))}async Re(t,e){let a={Ua:t,undo:e},s=await this.fe();if(s){At()&&+new Date-(await S().get("aliveIndicator")??0)>2e4&&await Ot(s);try{let r=!1;At()&&setTimeout(()=>{r||Ot(s)},1e3);let n=await chrome.tabs.sendMessage(s.id,{type:"stateChange",U:a});return r=!0,n}catch{}}}async Na(t,e){let a=new Set(t||[]),s=await $t(gt+"/api/createPage",{key:await o.Fe(),tabGroups:(await this.getState()).tabGroups.filter(r=>e||a.has(r.id))});await it(s.url,!1,!0)}async $a(t,e){let r=(await o.getState()).tabGroups.find(n=>n.id===t);await o.be(r,e)}async Je(){return await it(...arguments)}async He(){return await D(...arguments)}async ja(){return await pt(...arguments)}async it(t,e){e||(e={});let a=(await M()).find(s=>G(s.url));if(!a)throw new Error("OneTab tab not found");try{return await new Promise((s,r)=>{chrome.tabs.sendMessage(a.id,{type:t,...e},n=>{chrome.runtime.lastError?r(chrome.runtime.lastError.message):n&&n.error?r(n.error):s(n)})})}catch(s){throw new Error(s)}}async xt(){return await S().get("contextMenuState")??{}}async qe(t){await S().put("contextMenuState",t)}async Ve(){await g().put("lastSeenVersion","restoreTest"),await vt()}async Ke(t){await new Rt().Ge(t)}async ze(t,e){for(let a=0;a<t;a++)await new Rt().Ge(e)}async Ie(){let t=await o.getSettings();return E("oneTabTabState",t)||{}}async oe(t){await o.ft("oneTabTabState",t)}async Ja(t){let e=await this.Ie();Object.entries(t).forEach(([a,s])=>e[a]=s),await this.oe(e)}}async function Pt(){return new Promise((i,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):e&&e.length===1?i(e[0]):t("No current tab found")})})}function ae(i){return!!(i===""||de.some(t=>i.indexOf(t)===0))}function G(i){return i&&i.indexOf(u)===0}function ie(i){return i&&i.indexOf(N)===0}async function K(i){if(i!==void 0){let t=await chrome.tabs.query({windowId:i});return{tabs:t,activeTab:t.find(e=>e.active)}}else return await j()}async function j(){return new Promise((i,t)=>{(async()=>{let e={};if(chrome.windows){let a=await J(!1);if(a===void 0){i(void 0);return}e={windowId:a.id}}chrome.tabs.query(e,a=>{if(chrome.runtime.lastError)t(chrome.runtime.lastError.message);else{let s;for(let r of a)if(r.active){s=r;break}i({tabs:a,activeTab:s})}})})()})}async function se(i){return new Promise((t,e)=>{(async()=>chrome.tabs.query({windowId:i},a=>{if(chrome.runtime.lastError)e(chrome.runtime.lastError.message);else{let s;for(let r of a)if(r.active){s=r;break}t({tabs:a,activeTab:s})}}))()})}async function M(){return new Promise((i,t)=>{chrome.tabs.query({},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):i(e)})})}async function at(i){let t;return chrome.windows&&(t=await J(!1)),new Promise((e,a)=>{chrome.tabs.query({},s=>{if(chrome.runtime.lastError)a(chrome.runtime.lastError.message);else{let r=new Map;for(let l of s){let w=l.windowId;i&&t&&w===t.id||(r.has(w)||r.set(w,[]),r.get(w).push(l))}let n=Array.from(r.values());e(n)}})})}async function ne(i){return new Promise((t,e)=>{chrome.tabs.reload(i.id,{},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}async function W(i){return await Tt(i.id)}async function Tt(i){return new Promise((t,e)=>{chrome.tabs.remove(i,()=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message),t()})})}async function Et(i){return new Promise((t,e)=>{chrome.windows.remove(i,()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}function re(i,t){let e=new Map;return i.forEach(a=>{let s=a[t];e.has(s)||e.set(s,[]),e.get(s).push(a)}),e}async function oe(i,t){if(i.length===0)return;let e=i.some(c=>!c.pinned)?i.find(c=>!c.pinned).windowId:i[0].windowId,a=!!(await C(!1)).find(c=>c.id===e).incognito,s=await M(),r=re(s,"windowId"),n=r.get(e).filter(c=>!c.pinned&&!i.some(h=>h.id===c.id)).length===0,l=r.get(e).filter(c=>!i.some(h=>h.id===c.id)).length>0,w=(await C(!0)).filter(c=>!c.incognito&&c.id!==e);if(w.length>0)if(!l||!1)t?await o.Z(!1,w[0].id):await B(w[0].tabs[0]),await Et(e);else{if(t){let h=a?w[0].id:e;await o.Z(!1,h)}await Promise.all(i.map(h=>W(h)))}else t&&await o.Z(!1,a?void 0:e),await Promise.all(i.map(c=>W(c)))}async function B(i){return new Promise((t,e)=>{chrome.tabs.update(i.id,{active:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):chrome.windows?chrome.windows.update(i.windowId,{focused:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()}):t()})})}async function D(i){return i={...i},chrome.windows||delete i.windowId,new Promise((t,e)=>{chrome.tabs.create(i,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function Ct(i){return new Promise((t,e)=>{chrome.windows.create(i,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function Ue(i,t){return new Promise((e,a)=>{chrome.tabs.move(i,{index:t},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function C(i){return new Promise((t,e)=>{chrome.windows.getAll({populate:!!i},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function J(i){return new Promise((t,e)=>{chrome.windows.getLastFocused({populate:!!i},a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function it(i,t,e,a={}){if(a.url=i,a.pinned=!!t,a.active=!!e,chrome.windows){let s=await J(!1);s&&(a.windowId=s.id)}return await D(a)}async function pt(i){let t=await _(),e=await chrome.windows.create({url:V(i[0].url,t)}),a=[],s=await chrome.tabs.query({windowId:e.id}),r=!!i[0].pinned,n=s[s.length-1];r&&await chrome.tabs.update(n.id,{pinned:!0}),a.push(n);for(let l of i.slice(1)){let w=await D({url:V(l.url,t),pinned:!!l.pinned,windowId:e.id});a.push(w)}return{zt:e,Qt:a}}function le(){chrome.commands.onCommand.addListener(i=>{(async()=>(i==="display-onetab"&&await o.Z(),i==="send-current-tab-to-onetab"&&await o.re(),i==="send-all-tabs-in-current-window-to-onetab"&&await o.Wt(),i==="send-all-tabs-in-all-windows-to-onetab"&&await o.Kt(void 0),i==="send-all-tabs-except-this-to-onetab"&&await o.ge(void 0,void 0)))()})}function we(i){["onCreated","onUpdated","onMoved","onRemoved","onReplaced","onDetached","onAttached","onActivated"].forEach(t=>chrome.tabs[t].addListener(()=>i())),["onFocusChanged","onCreated","onRemoved"].forEach(t=>chrome.windows[t].addListener(()=>i()))}let st;async function kt(){if(st)return st.value;{let i=await S().get("oneTabTabId");return st={value:i},i}}async function nt(i){st={value:i},i===void 0?await S().remove("oneTabTabId"):await S().put("oneTabTabId",i)}async function rt(i){await o.ft("pinned",`${!!i}`)}function ue(){chrome.tabs.onRemoved.addListener(async(i,{windowId:t,isWindowClosing:e})=>{i===await kt()&&await nt(void 0)}),chrome.tabs.onUpdated.addListener(async(i,t,e)=>{try{let a=[e.url,e.pendingUrl].some(r=>G(r));i===await kt()&&!a&&e.pinned&&(await nt(void 0),await z(i,{pinned:!1})),a&&Object.hasOwn(t,"pinned")&&await rt(t.pinned)}catch(a){console.log(a)}})}function ce(i){return chrome.runtime.getURL(i)}async function Ft(){chrome.runtime.reload()}const de=[...["newtab","home","welcome","welcomeback"].map(i=>"about:"+i),...["newtab","new-tab-page"].map(i=>ut+i+"/")];async function mt(i){return new Promise((t,e)=>{chrome.tabs.get(i,a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function Dt(i){return new Promise((t,e)=>{chrome.tabs.query({},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a.filter(s=>s.url===i))})})}async function yt(i){let t=await Dt(i);if(t.length===0)throw new Error("No tab found with URL: "+i);if(t.length>1)throw new Error("More than one tab found with URL: "+i);return t[0]}async function z(i,t){return new Promise((e,a)=>{chrome.tabs.update(i,t,()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function A(i){i.title!==void 0&&(i.title=String(i.title).replaceAll("&","&&")),await chrome.contextMenus.create(i)}async function xt(i,t,e){await new Promise((a,s)=>{chrome.contextMenus.update(i,{enabled:t},()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):a()})}),(e[i]??={})[P]=+!!t}async function he(i,t,e){await new Promise((a,s)=>{chrome.contextMenus.update(i,{type:"checkbox",checked:t},()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):a()})}),(e[i]??={})[k]=+!!t}async function be(i,t,e,a){await new Promise((s,r)=>{chrome.contextMenus.update(i,{title:t},()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):s()})}),e&&((a[i]??={})[R]=t)}async function fe(){await chrome.contextMenus.removeAll()}async function ot(i){let t={type:"separator",contexts:["all"],id:qt().slice(0,10),parentId:i};await chrome.contextMenus.create(t)}async function Q(){let i={};if(await J(!1)!==void 0)try{let t=await o.getSettings(),e=await at(!0),a=await j();if(!a)return;let{tabs:s,activeTab:r}=a,n=G(r.url);await xt("displayOneTabMenu",!n,i);let l=I(r.url);await xt("excludeWebSiteContextMenu",!n,i);let w=l&&l.toLowerCase().indexOf("http")===0?x("excludeDomainFromOneTab").replace("DOMAIN.COM",$(l)):x("excludeWebSiteFromOneTab");await be("excludeWebSiteContextMenu",w,!0,i),await he("excludeWebSiteContextMenu",o.ye(l,t),i);let c=!1,h=!1,T=!1,p=!1,m=!1;if(r){let b=parseInt(r.index);c=s.some(f=>parseInt(f.index)<b&&f.url&&!o.Ft(f,I(f.url),t)),h=s.some(f=>parseInt(f.index)>b&&f.url&&!o.Ft(f,I(f.url),t)),p=s.some(f=>f.url&&!o.Ft(f,I(f.url),t)),T=s.some(f=>f.id!==r.id&&f.url&&!o.Ft(f,I(f.url),t))}m=e.some(b=>b.some(f=>f.url&&!o.Ft(f,I(f.url),t))),await Promise.all([["sendAllTabsInCurrentWindowMenu",p],["sendCurrentTabMenu",!(n||!p)],["sendTabsToTheLeftMenu",c],["sendTabsToTheRightMenu",h],["sendAllTabsInAllWindowsMenu",m],["sendTabsExceptThisMenu",T]].map(async([b,f])=>await xt(b,f,i))),await o.qe(i)}catch(t){console.log(t?.message),await Bt()>1e4&&!await S().get("contextMenusRecreatedDueToError")&&(await S().put("contextMenusRecreatedDueToError",!0),console.log("recreating context menus"),await H())}}async function H(){chrome.contextMenus&&(await fe(),await Te(),await Q())}async function Te(){await A({id:"rootContextMenu",title:"OneTab",type:"normal",contexts:["all"]}),await A({id:"displayOneTabMenu",title:x("displayOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendAllTabsInCurrentWindowMenu",title:x("sendAllTabsToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendThisWebLinkMenu",title:x("sendThisWebLinkToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["link"]}),await ot("rootContextMenu"),await A({id:"sendCurrentTabMenu",title:x("sendOnlyThisTabToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendTabsExceptThisMenu",title:x("sendAllTabsExceptThisToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendTabsToTheLeftMenu",title:x("sendLeftTabsToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendTabsToTheRightMenu",title:x("sendRightTabsToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await A({id:"sendAllTabsInAllWindowsMenu",title:x("sendAllTabsAllWindowsToOneTab"),parentId:"rootContextMenu",type:"normal",contexts:["all"]}),await ot("rootContextMenu"),await A({id:"excludeWebSiteContextMenu",title:x("excludeWebSiteFromOneTab"),parentId:"rootContextMenu",type:"checkbox",checked:!1,contexts:["all"]});let t=(await o.getState()).tabGroups;t||(t=[]),t=t.slice(0,500);let e=t.filter(a=>a.label&&a.label!=="");if(e.length){await ot("rootContextMenu"),await A({id:"namedTabGroups",title:x("namedTabGroups"),parentId:"rootContextMenu",type:"normal",contexts:["all"]});for(let a of e){let s=`namedTabGroups-${a.id}`;await A({id:s,title:a.label,parentId:"namedTabGroups",type:"normal",contexts:["all"]});for(let{Dt:r,title:n,contexts:l}of[{Dt:"sendAllTabsInCurrentWindowMenu",title:x("sendAllTabsToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["all"]},{Dt:"sendThisWebLinkMenu",title:x("sendThisWebLinkToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["link"]},{Dt:"sendCurrentTabMenu",title:x("sendOnlyThisTabToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["all"]},{Dt:"sendTabsExceptThisMenu",title:x("sendAllTabsExceptThisTabToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["all"]},{Dt:"sendTabsToTheLeftMenu",title:x("sendLeftTabsToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["all"]},{Dt:"sendTabsToTheRightMenu",title:x("sendRightTabsToPlaceholder").replace("PLACEHOLDER",a.label),contexts:["all"]}])await A({id:`${r}:${a.id}`,title:n,parentId:s,type:"normal",contexts:l})}}await ot("rootContextMenu"),await A({id:"helpMenu",title:x("help"),parentId:"rootContextMenu",type:"normal",contexts:["all"]})}class Rt{async Ge(t){try{if(ct&&!await Y())throw new Error("Need tab groups permission");for(let e=0;e<2;e++){await this.dt(y);let a=e===0;await rt(a),console.log(`begin tests with pinned: ${a}`),await this.Qe(t.pdfFileUrl),await this.Ye(a),await this.Xe(t.pdfFileUrl),await this.Ze(),await Y()&&(await this._e(),await this.ta()),await this.ea(),await this.aa(),await this.ia(),await this.sa(),await this.na(),a&&await this.ra(),await this.oa(),await this.la(),await this.wa(),await this.ua(),await this.We({ctrlKey:!0}),await this.We({metaKey:!0}),await this.ca(),await this.da(),await this.ha(),await this.ba(),await this.fa(),await this.Ta(),await this.pa(),await this.ma(),await this.ya(),await this.xa(),await this.ga(),await this.Sa(),console.log(`tests completed with pinned: ${a}`)}console.log("all tests completed")}finally{let e=ut+"extensions/";await this.dt(e);let a=await o.getState();a.tabGroups=a.tabGroups.filter(s=>s.tabsMeta.every(r=>!(r.title.startsWith("t---")||r.title.startsWith("PIN::t---")||r.url.startsWith("http://localhost")||r.url===t.pdfFileUrl))),await o.Ut(a),await rt(!0),console.log("done.")}}async ea(){let t=await o.Mt();console.log("begin testAutoUnPin");let e={tt:[this.et(),this.et(),this.et()]};await this.ot(e,!0),await o.Z(),await this.nt();let a=await yt(u);this.assert((await mt(a.id)).pinned===t),await z(a.id,{url:this.et()}),await d(200),this.assert(!(await mt(a.id)).pinned),await o.Z(),await this.nt();let s=await yt(u);this.assert(s.pinned===t)}async aa(){console.log("begin testDuplicateOneTabTabAdded");let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt();let a=(await yt(u)).id;await D({url:u}),await D({url:u}),await d(500),this.assert((await Dt(u)).length===1),await this.Tt(u),this.assert((await Pt()).id===a)}async wa(){console.log("begin testSimulateRestoreClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt(),await o.Wt(),await o.it("clickTab",{url:t.tt[0],wt:{}}),await this.lt({tt:[u,t.tt[0]]}),await this.Tt(u),await o.it("clickTab",{url:t.tt[1],wt:{shiftKey:!0}}),await this.Ma(t.tt[1]),await this.At(t.tt[1]),await o.it("clickTab",{url:t.tt[2],wt:{ctrlKey:!0}}),await d(300),await this.Tt(u),await d(1e3),await this.rt({tt:[u,t.tt[0],t.tt[2]]}),await o.it("clickTab",{url:t.tt[3],wt:{metaKey:!0}}),await d(300),await this.Tt(u),await d(1e3),await this.rt({tt:[u,t.tt[0],t.tt[2],t.tt[3]]}),await this.ct(0,[t.tt[1],t.tt[2],t.tt[3]])}async ha(){console.log("begin testTabsAddedToExistingGroup"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt();let e=await o.Mt();await this.lt({tt:e?[u,...t.tt]:[...t.tt,u]}),await o.Wt(),await this.ct(0,[...t.tt]),await this.lt({tt:[u]});let a={tt:[this.et()]};await this.ot(a,!1),await this.lt({tt:[u,a.tt[0]]}),await this.gt(a.tt[0]),await o.re(),await d(200),await this.ct(0,[a.tt[0],...t.tt])}async ua(){console.log("begin testSimulateRestoreTabGroupClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt(),await d(200),await o.Wt(),await this.ct(0,[...t.tt]),await this.lt({tt:[u]}),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:t.tt[0],wt:{}}),await d(200),await this.Ct(0,t.tt[0]),await this.lt({tt:[u,...t.tt]}),await this.Tt(u)}async We(t){console.log("begin testSimulateRestoreTabGroupCtrlOrMetaClick"),await this.dt(y);let e={tt:[this.et(),this.et(),this.et()]};await this.ot(e,!0),await o.Z(),await this.nt(),await d(200),await o.Wt(),await d(200),await this.ct(0,[...e.tt]),await this.lt({tt:[u]}),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:e.tt[0],wt:t}),await d(200),await this.ct(0,[...e.tt]),await this.lt({tt:[u,...e.tt]}),await this.Tt(u)}async ca(){console.log("begin testSimulateRestoreTabGroupShiftClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt(),await d(200),await o.Wt(),await this.ct(0,[...t.tt]),await this.lt({tt:[u]}),await this.nt(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:t.tt[0],wt:{shiftKey:!0}}),await this.ct(0,[...t.tt]),await this.lt({tt:[...t.tt],other:[[u]]})}async da(){console.log("begin testSimulateDeleteTabGroupClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await o.Z(),await this.nt(),await d(200),await o.Wt(),await d(200),await this.ct(0,[...t.tt]),await this.Ot(t.tt,0,!0),await this.Ga(t.tt[0]),await this.nt(),await o.it("clickTabGroupButton",{ht:"deleteAllButton",ut:t.tt[0]}),await d(200),await this.Ct(0,t.tt[0]),await d(200),await this.Ia(t.tt[0])}async Ct(t){let e=await o.it("getVisibleStructure");this.assert(e.tabGroups.every(a=>!a.tabs.some(s=>s===t)))}async ct(t,e){await d(200);let a=await o.it("getVisibleStructure"),s=a.tabGroups.findIndex(r=>!r.le);this.assert(this.Ae([e],a.tabGroups.slice(s+t,s+t+1).map(r=>r.tabs)),`assertUnstarredTabGroup fail: expected: ${e}`)}async la(){console.log("begin testOneTabTabUpdated"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()],[this.et(),this.et()]]};await this.ot(t,!0),await o.Z(!1),await this.nt();let e=await o.Mt();await this.rt({tt:e?[u,...t.st[1]]:[...t.st[1],u],other:[t.tt,...t.st.slice(0,-1)]}),await o.Kt(),await this.nt();let a=await o.it("getVisibleStructure");this.Gt(a.Wa,a.tabGroups.reduce((r,n)=>r+n.Aa,0),"visible total tab count === summed visible tabgroup counts"),this.Gt(a.Wa,a.tabGroups.reduce((r,n)=>r+n.tabs.length,0),"visible total tab count === summed visible tabs"),this.assert(a.tabGroups.every(r=>r.Aa===r.tabs.length));let s=a.tabGroups.findIndex(r=>!r.le);this.assert(a.tabGroups.every((r,n)=>n<s&&r.le||n>=s&&!r.le)),this.assert(this.Ae([t.tt,...t.st],a.tabGroups.slice(s,s+3).map(r=>r.tabs)))}Ae(t,e){return t.map(a=>a.join(" ")).sort().join(`
`)===e.map(a=>a.join(" ")).sort().join(`
`)}async oa(){if(console.log("begin testOneTabTabComms"),await o.Z(!1),await this.nt(),!(await o.it("ping")).pong)throw new Error("comms test failed")}async Ze(){console.log("begin testBrowserActionClick"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[0],other:[t.tt]}),await this.bt(),await this.nt();let e=await o.Mt();await this.rt({tt:e?[u,...t.tt]:[...t.tt,u],other:[]})}async _e(){console.log("begin testBrowserGroupSaveAndRestore");let t=[{Xt:3,$t:[0,1,2],jt:[3,4,5],Zt:!0,_t:async()=>await this.bt()},{Xt:1,$t:[3,4,5],jt:[0,1,2],Zt:!1,_t:async()=>await this.bt()},{Xt:5,$t:[0,1,2,5],jt:[3,4],Zt:!0,_t:async()=>(await o.Se(),await o.Z())},{Xt:3,$t:[0,1,2,3],jt:[4,5],Zt:!0,_t:async()=>(await o.Me(),await o.Z())}];for(let e of t){await this.dt(y);let a={tt:[this.et(),this.et(),this.et(),this.et(),this.et(),this.et()]},s=await this.ot(a,!0);await this.rt({tt:a.tt}),await chrome.tabs.group({createProperties:{windowId:s.tt[0].windowId},tabIds:s.tt.map(n=>n.id).slice(3)}),await this.gt(a.tt[e.Xt]),await e._t(),await this.nt();let r=await o.Mt();await this.rt({tt:r?[u,...e.$t.map(n=>a.tt[n])]:[...e.$t.map(n=>a.tt[n]),u]}),await this.Ot(e.jt.map(n=>a.tt[n]),0,!0),await this.nt(),this.assert((await o.it("getTabGroupElementDisplayed",{Jt:"tabGroupImg",ut:a.tt[e.jt[0]]})).Ht===e.Zt)}}async ta(){console.log("begin testBrowserGroupSaveAndRestore2"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et(),this.et(),this.et(),this.et()],st:[[this.et(),this.et()]]},e=await this.ot(t,!0);await this.rt({tt:t.st[0],other:[t.tt]}),await chrome.tabs.group({createProperties:{windowId:e.tt[0].windowId},tabIds:e.tt.map(s=>s.id).slice(1,3)}),await chrome.tabs.group({createProperties:{windowId:e.tt[0].windowId},tabIds:e.tt.map(s=>s.id).slice(4,6)}),await o.Kt(),await o.Z(),await this.nt();let a=await o.Mt();await this.rt({tt:[u]}),await this.Ot([0,1].map(s=>t.st[0][s]),0,!0),await this.Ot([0,3].map(s=>t.tt[s]),1,!0),await this.Ot([1,2].map(s=>t.tt[s]),2,!0),await this.Ot([4,5].map(s=>t.tt[s]),3,!0),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:t.tt[4],wt:{}}),await d(200),await this.Ct(0,t.tt[4]),await this.Ct(0,t.tt[5]),await this.lt({tt:[u,...t.tt.slice(4)]}),await this.Tt(u)}async ia(){console.log("begin testContextMenus"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()],[this.qt(),this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,t.st[0]]});let e=500;const a=(c,h,T)=>{this.assert(c[h][P]===+T)},s=(c,h,T)=>{this.assert(c[h][k]===+T)},r=(c,h,T)=>{this.assert(c[h][R]===T)};await this.gt(t.tt[0]),await d(e),await Q();let n=await o.xt();a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!0),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"displayOneTabMenu",!0),a(n,"excludeWebSiteContextMenu",!0),s(n,"excludeWebSiteContextMenu",!1),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await this.gt(t.tt[1]),await d(e),n=await o.xt(),a(n,"sendTabsToTheLeftMenu",!0),a(n,"sendTabsToTheRightMenu",!1),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"sendCurrentTabMenu",!0),a(n,"displayOneTabMenu",!0),a(n,"excludeWebSiteContextMenu",!0),s(n,"excludeWebSiteContextMenu",!1),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await this.gt(t.st[0][0]),await d(e),n=await o.xt(),a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!0),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"sendCurrentTabMenu",!0),a(n,"displayOneTabMenu",!0),a(n,"excludeWebSiteContextMenu",!0),s(n,"excludeWebSiteContextMenu",!1),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await this.gt(t.st[1][1]),await d(e),n=await o.xt(),a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!0),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"sendCurrentTabMenu",!0),a(n,"displayOneTabMenu",!0),a(n,"excludeWebSiteContextMenu",!0),s(n,"excludeWebSiteContextMenu",!1),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await o.Z(),await this.nt();let l=await this.Vt(),w=await o.Mt();await this.rt({tt:w?[u,...t.st[1]]:[...t.st[1],u],other:[t.tt,t.st[0]]}),await this.Tt(u),await this.nt(),await d(5*e),n=await o.xt(),w?(a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!0)):(a(n,"sendTabsToTheLeftMenu",!0),a(n,"sendTabsToTheRightMenu",!1)),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"sendCurrentTabMenu",!1),this.assert(!n.displayOneTabMenu[P]),this.assert(!n.excludeWebSiteContextMenu[P]),await this.gt(t.st[1][0]),await d(e),n=await o.xt(),a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!0),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!0),a(n,"sendAllTabsInCurrentWindowMenu",!0),a(n,"sendCurrentTabMenu",!0),this.assert(n.displayOneTabMenu[P]),this.assert(n.excludeWebSiteContextMenu[P]),this.assert(!n.excludeWebSiteContextMenu[k]),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await this.gt(t.st[0][0]),await this.Tt(t.st[0][0]),await o.Z(),await this.Tt(u),await this.gt(t.st[1][0]),await this.Tt(t.st[1][0]),await this.At(t.st[1][1]),await this.At(t.st[1][2]),await d(e),n=await o.xt(),a(n,"sendTabsToTheLeftMenu",!1),a(n,"sendTabsToTheRightMenu",!1),a(n,"sendAllTabsInAllWindowsMenu",!0),a(n,"sendTabsExceptThisMenu",!1),a(n,"sendAllTabsInCurrentWindowMenu",!1),a(n,"sendCurrentTabMenu",!1),this.assert(n.displayOneTabMenu[P]),this.assert(n.excludeWebSiteContextMenu[P]),this.assert(!n.excludeWebSiteContextMenu[k]),r(n,"excludeWebSiteContextMenu","Exclude localhost from OneTab"),await this.At(t.st[1][0]),await d(e),n=await o.xt(),a(n,"sendAllTabsInCurrentWindowMenu",!1),await Promise.all((await M()).filter(c=>c.url!==u&&c.url!==t.tt[0]).map(c=>W(c))),await this.gt(t.tt[0]),await d(e),n=await o.xt(),a(n,"sendAllTabsInAllWindowsMenu",!1)}async sa(){console.log("begin testExcludeWebSiteContextMenu"),await this.dt(y),await o.ne("127.0.0.1");let t={tt:[this.et("127.0.0.1"),this.et()],st:[[this.et(),this.et()],[this.et(),this.et("127.0.0.1"),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,...t.st.slice(0,-1)]}),await d(1e3);let e=await o.xt();this.assert(e.excludeWebSiteContextMenu[P]),this.assert(!e.excludeWebSiteContextMenu[k]),this.Gt(e.excludeWebSiteContextMenu[R],"Exclude localhost from OneTab"),await this.gt(t.st[1][1]),await d(1e3),e=await o.xt(),this.assert(e.excludeWebSiteContextMenu[P]),this.assert(!e.excludeWebSiteContextMenu[k]),this.Gt(e.excludeWebSiteContextMenu[R],"Exclude 127.0.0.1 from OneTab"),await o.xe("127.0.0.1");{let a=await o.getSettings(),s=o.Yt("127.0.0.1",a);this.assert(s)}await this.gt(t.tt[1]),await d(1e3),e=await o.xt(),this.assert(e.excludeWebSiteContextMenu[P]),this.assert(!e.excludeWebSiteContextMenu[k]),this.Gt(e.excludeWebSiteContextMenu[R],"Exclude localhost from OneTab"),await this.gt(t.tt[0]),await d(1e3),e=await o.xt(),this.assert(e.excludeWebSiteContextMenu[P]),this.assert(e.excludeWebSiteContextMenu[k]),this.Gt(e.excludeWebSiteContextMenu[R],"Exclude 127.0.0.1 from OneTab"),await o.ne("127.0.0.1"),await Q(),await d(1e3),e=await o.xt(),this.assert(e.excludeWebSiteContextMenu[P]),this.assert(!e.excludeWebSiteContextMenu[k]),this.Gt(e.excludeWebSiteContextMenu[R],"Exclude 127.0.0.1 from OneTab")}async na(){console.log("begin testIgnoreOneTabContentPages");let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await o.kt("import-export.html"),await o.kt("options.html"),await o.kt("import-export.html"),await o.kt("options.html");let e={st:[[this.et(),this.et()]]};await this.ot(e,!1),await o.kt("import-export.html"),await o.kt("options.html"),await this.At(e.st[0][0]),await this.At(e.st[0][1]),await this.rt({tt:[...t.tt,N+"import-export.html",N+"options.html"]}),await this.bt(),await this.rt({tt:[u]})}async ra(){console.log("begin testExistingOneTabSwitchedTo");let t={tt:[this.et()],st:[[this.et(),this.et()],[this.et(),this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,...t.st.slice(0,-1)]}),await o.Z();let e=await o.Mt();await this.rt({tt:e?[u,...t.st[1]]:[...t.st[1],u],other:[t.tt,...t.st.slice(0,-1)]}),await this.gt(t.tt[0]),await this.Tt(t.tt[0]),await o.Z(!0),await this.Tt(t.tt[0]),await o.Z(),await this.Tt(u),await this.rt({tt:e?[u,...t.st[1]]:[...t.st[1],u],other:[t.tt,...t.st.slice(0,-1)]})}async Ha(){console.log("begin safariPinnedTabsTest"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[0],other:[t.tt]});let e=await C(!0),a=e.find(n=>n.focused),s=e.find(n=>!n.focused),r=200;await d(r),await o.Z(),await this.nt(),await d(r),this.Gt((await C(!0)).find(n=>n.focused).id,a.id),await B(a.tabs[1]),await d(r),await o.Z(),await d(r),this.Gt((await C(!0)).find(n=>n.focused).id,a.id),await B(s.tabs[1]),await d(r),await o.Z(),await d(r),this.Gt((await C(!0)).find(n=>n.focused).id,s.id)}async ba(){console.log("begin testPinnedTabsOption"),await this.dt(y);let t=await o.getSettings(),e=E("pinnedTabs",t);try{await o.ft("pinnedTabs","ignore");let a={tt:[this.qt(),this.et()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await d(500);let s=await o.Mt();s?(await d(500),await this.rt({tt:[u,a.tt[0]]},!0)):await this.rt({tt:[a.tt[0],u]}),await this.At(a.tt[0]),await this.rt({tt:[u]}),await o.ft("pinnedTabs","allow"),await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await d(100),await this.rt({tt:[u]}),await this.Ot(a.tt,0,!0),await o.it("clickTab",{url:a.tt[0],wt:{}}),await this.lt({tt:s?[u,a.tt[0]]:[a.tt[0],u]}),await this.Oa(a.tt[0])}finally{await o.ft("pinnedTabs",e)}}async fa(){console.log("begin testPinnedTabsOption2"),await this.dt(y);let t=await o.getSettings(),e=E("pinnedTabs",t);try{await o.ft("pinnedTabs","allow");let a={tt:[this.qt(),this.qt()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await this.rt({tt:[u]});let s={tt:[this.et()]};await this.ot(s,!1),await this.rt({tt:[u,...s.tt]}),await this.nt(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[...a.tt],other:[[u,...s.tt]]}),await this.bt(),await this.ct(0,[...a.tt]),await this.At(s.tt[0]),await this.rt({tt:[u]}),await this.nt(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}});let r=await o.Mt();await this.lt({tt:r?[u,...a.tt]:[...a.tt,u]})}finally{await o.ft("pinnedTabs",e)}}async Ta(){console.log("begin testPinnedTabsOption3"),await this.dt(y);let t=await o.getSettings(),e=E("pinnedTabs",t);try{await o.ft("pinnedTabs","allow");let a={tt:[this.qt()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await this.rt({tt:[u]});let s={tt:[this.et()]};await this.ot(s,!1),await this.rt({tt:[u,...s.tt]}),await this.nt(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[...a.tt],other:[[u,...s.tt]]}),await this.bt(),await this.ct(0,[...a.tt]),await this.At(s.tt[0]),await this.rt({tt:[u]}),await this.nt(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}});let r=await o.Mt();await this.lt({tt:r?[u,...a.tt]:[...a.tt,u]})}finally{await o.ft("pinnedTabs",e)}}async pa(){console.log("begin testRestoreRemovalOption"),await this.dt(y);let t=await o.getSettings(),e=E("restoreRemoval",t);try{await o.ft("restoreRemoval","default");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await d(200),await this.ct(0,[...a.tt]),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,...a.tt]}),await this.Ct(a.tt[0]),await o.ft("restoreRemoval","keep"),await this.bt(),await this.nt(),await this.ct(0,[...a.tt]),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,...a.tt]}),await this.ct(0,[...a.tt])}finally{await o.ft("restoreRemoval",e)}}async ma(){console.log("begin testDuplicatesOption"),await this.dt(y);let t=await o.getSettings(),e=E("restoreRemoval",t);try{await o.ft("restoreRemoval","default");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await d(200),await this.ct(0,[...a.tt]),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,...a.tt]}),await this.Ct(a.tt[0]),await o.ft("restoreRemoval","keep"),await this.bt(),await this.nt(),await this.ct(0,[...a.tt]),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,...a.tt]}),await this.ct(0,[...a.tt])}finally{await o.ft("restoreRemoval",e)}}async ya(){console.log("begin testRestoreWindowOption"),await this.dt(y);let t=await o.getSettings(),e=E("restoreWindow",t);try{await o.ft("restoreWindow","newWindow");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await this.lt({tt:[u]}),await this.ct(0,[...a.tt]),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,...a.tt]}),await this.bt(),await this.lt({tt:[u]}),await this.ct(0,[...a.tt]);let s={tt:[this.et()]};await this.ot(s,!1),await o.Z(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[...a.tt],other:[[u,...s.tt]]}),await o.ft("restoreWindow","newWindowAlways"),await this.bt(),await this.nt(),await this.At(s.tt[0]),await this.lt({tt:[u]}),await this.ct(0,[...a.tt]),await o.Z(),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[...a.tt],other:[[u]]}),await this.bt(),await this.nt(),await this.lt({tt:[u]}),await this.ct(0,[...a.tt]),await o.ft("restoreWindow","currentWindow"),await o.Z(),await this.ot(s,!1),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:a.tt[0],wt:{}}),await this.lt({tt:[u,s.tt[0],...a.tt]})}finally{await o.ft("restoreWindow",e)}}async xa(){console.log("begin testLockUnlock"),await this.dt(y);let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await this.bt(),await this.nt(),await this.lt({tt:[u]}),await this.ct(0,[...t.tt]),await d(150),this.assert(!(await o.it("getTabGroupElementDisplayed",{Jt:"lockImg",ut:t.tt[0]})).Ht),this.assert(!(await this.ae(t.tt[0])).starred),await o.it("clickTabGroupButton",{ht:"moreButton",ut:t.tt[0],wt:{}}),await o.it("clickTabGroupButton",{ht:"toggleLockTabGroupButton",ut:t.tt[0],Oe:"mousedown",wt:{}}),await d(150),this.assert((await this.ae(t.tt[0])).locked),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:t.tt[0],wt:{}}),await d(200),await this.lt({tt:[u,...t.tt]}),await this.ct(0,[...t.tt]),await o.it("clickTabGroupButton",{ht:"deleteAllButton",ut:t.tt[0]}),await d(200),await this.ct(0,[...t.tt]),await o.it("clickTab",{url:t.tt[0],wt:{}}),await d(200),await this.ct(0,[...t.tt]),this.assert((await o.it("getTabGroupElementDisplayed",{Jt:"lockImg",ut:t.tt[0]})).Ht)}async ga(){console.log("begin testStarUnstar"),await this.dt(y);let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await this.bt(),await this.nt(),await this.lt({tt:[u]}),await d(200),await this.ct(0,[...t.tt]);let e={tt:[this.et(),this.et()]};await this.ot(e,!0),await this.bt(),await this.nt(),await d(200),await this.lt({tt:[u]}),await this.ct(0,[...e.tt]);let a=await o.it("getVisibleStructure"),s=a.tabGroups.findIndex(w=>w.tabs.some(c=>c===t.tt[0])),r=a.tabGroups.findIndex(w=>w.tabs.some(c=>c===e.tt[0]));this.assert(s>0),this.assert(!(await o.it("getTabGroupElementDisplayed",{Jt:"starImg",ut:t.tt[0]})).Ht),await o.it("clickTabGroupButton",{ht:"moreButton",ut:t.tt[0],wt:{}}),await d(300),await o.it("clickTabGroupButton",{ht:"toggleStarTabGroupButton",ut:t.tt[0],Oe:"mousedown",wt:{}}),await d(1200),this.assert((await o.it("getTabGroupElementDisplayed",{Jt:"starImg",ut:t.tt[0]})).Ht),a=await o.it("getVisibleStructure");let n=a.tabGroups.findIndex(w=>w.tabs.some(c=>c===t.tt[0]));this.assert(n===0),this.assert(n===await this.Pe(t.tt[0])),this.assert((await this.ae(t.tt[0])).starred),await o.it("clickTabGroupButton",{ht:"moreButton",ut:t.tt[0],wt:{}}),await o.it("clickTabGroupButton",{ht:"toggleStarTabGroupButton",ut:t.tt[0],Oe:"mousedown",wt:{}}),await d(600),a=await o.it("getVisibleStructure");let l=a.tabGroups.findIndex(w=>w.tabs.some(c=>c===t.tt[0]));this.assert(s===l),this.assert(s===await this.Pe(t.tt[0])),this.assert(!(await this.ae(t.tt[0])).starred),this.assert(!(await o.it("getTabGroupElementDisplayed",{Jt:"starImg",ut:t.tt[0]})).Ht)}async Qe(t){console.log("begin testFileUrls");let e;try{await this.dt(y);let a={tt:[t]};await this.ot(a,!0),await this.rt({tt:[t]}),await this.bt(),await this.nt(),await this.Ot([t],0,!0);let s=V(t,await _());await o.it("clickTab",{url:s,wt:{}})}catch(a){e=String(a)}this.Gt(e,void 0)}async Xe(t){console.log("begin testPdfPlaceholders"),await this.dt(y);let e=V(t,await _());this.assert(t!==e&&!e.startsWith("file://"),"pdfFilePlaceholderUrl not determined correctly");let a={tt:[t]};await this.ot(a,!0),await this.rt({tt:[t]}),await this.bt(),await d(200),await this.rt({tt:[u]}),await this.nt(),await this.Ot([t],0,!0),await o.it("clickTab",{url:e,wt:{}}),await this.lt({tt:[u,e]}),await this.bt(),await this.Ot([t],0,!0),await d(200),await o.it("clickTabGroupButton",{ht:"restoreAllButton",ut:e,wt:{}}),await d(200),await this.Ct(0,e),await this.Ct(0,t),await this.lt({tt:[u,e]})}async Sa(){await o.Z(),await this.nt();let t=await o.it("testExtFavIconLoad");this.assert(t.success)}async Vt(){let t=(await M()).filter(a=>G(a.url));this.Pa(t.length,0,"cannot find any onetab tab");let e=t[0];return this.Gt(t.length,1,"there should only be exactly one onetab tab"),e}async Ye(t){console.log("begin testPreserveLastOneTabTabPinnedState"),await o.Z(),await this.nt();let e=await this.Vt(),a=e.pinned,s=500;a||(await z(e.id,{pinned:!0}),await d(s),await W(e),await d(s),await o.Z(),await this.nt(),e=await this.Vt(),await d(s),this.assert(e.pinned)),a&&(await z(e.id,{pinned:!1}),await d(200),await W(e),await o.Z(),await this.nt(),e=await this.Vt(),this.assert(!e.pinned),await z(e.id,{pinned:!0}),await d(200),await W(e),await d(200),await o.Z(),await this.nt(),await d(200),e=await this.Vt(),this.assert(e.pinned)),await rt(t)}async Ot(t,e,a){let s=await o.getState();a&&(e+=s.tabGroups.findIndex(n=>!n.starred));let r=s.tabGroups.some((n,l)=>e!==void 0&&e!==l?!1:n.tabsMeta.every((w,c)=>{let h=t[c];if(h.includes(":3000/?title=")){let T=this.we(h,"title")===w.title;return this.we(h,"title").startsWith("PIN::")&&!w.pinned&&(T=!1),T||console.log(`assertStoredTabGroup mismatch: ${this.we(h,"title")} vs ${w.title}`),T}else return h===w.url}));this.assert(r,`assertStoredTabGroup fail, expected: ${t} at index ${e}`)}async Ga(t){let e=await o.getState();this.assert(e.tabGroups.some(a=>a.tabsMeta.some(s=>s.url===t)))}async Ia(t){let e=await o.getState();this.assert(!e.tabGroups.some(a=>a.tabsMeta.some(s=>s.url===t)))}async Pe(t){return(await o.getState()).tabGroups.findIndex(e=>e.tabsMeta[0].url===t)}async ae(t){return(await o.getState()).tabGroups.find(e=>e.tabsMeta[0].url===t)}we(t,e){t=t.substring(t.indexOf("?")+1);let a=t.split("&");for(let s in a){let r=a[s].split("=");if(r[0]===e)return decodeURIComponent(r[1])}}async dt(t){let a=(await M()).filter(r=>r.url&&!(r.title&&r.title.startsWith("t---")||r.title&&r.title.startsWith("PIN::t---")||r.title&&r.title.startsWith("localhost:"))&&![r.url,r.pendingUrl].some(n=>[N,ut,"file://"].some(l=>n&&n.startsWith(l))));if(a=a.filter(r=>!r.url.startsWith("http://localhost")),a.length>0)throw console.log(a),new Error(`Non-empty tabs found, aborting browser reset. ${a.map(r=>r.url).join(",")}`);let s=await C(!0);if(s.length===0)console.log("resetToSingleEmptyTabOpen: no open windows"),await Ct({url:t});else{s.slice(1).forEach(w=>Et(w.id));let r=s[0],{tabs:n,activeTab:l}=await se(r.id);await D({windowId:r.id,url:t}),await Promise.all(n.map(w=>W(w)))}await this.ie()}async ie(){await Wt(1e4,"waitForAllTabsLoaded",async()=>!(await M()).some(t=>t.status==="loading"))}async ot(t,e){let a={tt:[],st:[]},s=[];if(e&&(s=await M()),t.tt)for(let r=0;r<t.tt.length;r++)a.tt.push(await this.openTab(t.tt[r]));if(t.st)for(let r=0;r<t.st.length;r++){let{zt:n,Qt:l}=await this.Ea(t.st[r]);a.st.push(l)}return await Promise.all(s.map(r=>W(r))),await this.ie(),a}async lt(t){await this.ie(),await Wt(1e4,"waitForAndAssertTabStructure",async e=>{try{return await this.rt(t),!0}catch(a){return e>3e3&&console.log(a),!1}})}async Oa(t){let e=await at();this.assert(e.some(a=>a.some(s=>[s.url,s.pendingUrl].some(r=>r===t)&&s.pinned)))}async rt(t,e){if(!t.tt&&!t.other)throw new Error("invalid tabStruct");await this.ie();let a=await at(!0);if(!await j())throw new Error("No lastFocusedWindow found");let r=(await j()).tabs;if(t.tt){let n=r.map(w=>[w.url,w.pendingUrl].find(c=>c)).join(" , "),l=t.tt.join(" , ");if(n!==l){let w=`No match for tabs in last focused window (actual, expected): 
${n}

${l}`;throw new Error(w)}}if(t.other){let n=a.map(w=>w.map(c=>[c.url,c.pendingUrl].find(h=>h)).join(" , ")).sort().join(`
`),l=t.other.map(w=>w.join(" , ")).sort().join(`
`);if(n!==l){let w=`No match for tabs in non focused windows (actual, expected):
${n}

${l}`;throw new Error(w)}}}async Ma(t){for(let e of bt(5e3))try{await this.Tt(t);return}catch{await d(e)}throw new Error("waitForAndAssertActiveTab failed after time-out")}async nt(){for(let t of bt(1e4)){try{if((await M()).some(e=>G(e.url)))try{await o.it("ping");return}catch{}}catch(e){console.log(e)}t>200&&console.log(`waitForOneTabTabExistsAndRespondsToRpc pause for: ${t}`),await d(t)}throw new Error("waitForOneTabTabExistsAndRespondsToRpc failed after time-out")}async Tt(t){let e=(await Pt()).url;if(e!==t)throw new Error(`active tab not as expected (actual, expected): "${e}", "${t}"`)}async openTab(t){return await o.Je(t,t.includes("?title="+encodeURIComponent("PIN::")))}async Ea(t){let{zt:e,Qt:a}=await pt(t.map(s=>({url:s,pinned:s.includes("?title="+encodeURIComponent("PIN::"))})));return{zt:e,Qt:a}}async bt(){await o.Wt(void 0)}async gt(t){await B((await M()).find(e=>e.url===t))}async At(t){let e=(await M()).find(a=>a.url===t);if(!e)throw new Error("Could not find tab with URL: "+t);await W(e)}Ee(t,e){return e||(e="localhost"),`http://${e}:3000/?title=${encodeURIComponent(t)}`}et(t){return this.Ee(this.uuid(),t)}qt(t){return this.Ee("PIN::"+this.uuid(),t)}uuid(){return"t---"+X(6,16).toLowerCase()}assert(t,e){if(!t)throw new Error("Assertion failed"+(e?" "+e:""))}Gt(t,e,a){if(t!==e)throw new Error(`Assertion failed, ${t} !== ${e}, ${a}`)}Pa(t,e,a){if(!(t>e))throw new Error(`Assertion failed, ! (${t} > ${e}), ${a}`)}}let o=new L;async function Bt(){let i=+new Date,t=await S().get("firstLoadTimestamp");return t||(t=i,await S().put("firstLoadTimestamp",i)),i-t}Bt(),pe();async function vt(){setTimeout(()=>Ft(),3e4);try{let t=(await M()).find(a=>G(a.url)),e=t?{index:t.index,windowId:t.windowId,pinned:t.pinned,active:t.active,updateDate:new Date().getTime(),updateEvent:"onUpdateAvailable"}:{};await o.oe(e)}catch(i){console.log(i)}await Ft()}function pe(){ye(),chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener(async()=>{await vt()});let i;chrome.runtime.onInstalled.addListener(async s=>{await(i??(i=t())),await H()}),chrome.runtime.onStartup.addListener(async()=>{await(i??(i=t()))});async function t(){try{await o.Ne(),await S().clearAll(),await me()}catch(s){console.log("onStartup exception"),console.log(s)}}async function e(s){await St(),await o.Wt(void 0,s)}chrome.action.onClicked.addListener(async s=>e(s));const a={displayOneTabMenu:async(s,r)=>await o.$e(r?.windowId),sendAllTabsInCurrentWindowMenu:async(s,r,n)=>await o.Wt(n,r),sendThisWebLinkMenu:async(s,r,n)=>await o.je(s,r,n),sendCurrentTabMenu:async(s,r,n)=>await o.re(n,r),sendTabsExceptThisMenu:async(s,r,n)=>await o.ge(n,r),sendTabsToTheLeftMenu:async(s,r,n)=>await o.Se(n,r),sendTabsToTheRightMenu:async(s,r,n)=>await o.Me(n,r),sendAllTabsInAllWindowsMenu:async(s,r,n)=>await o.Kt(n),helpMenu:async(s,r)=>await it(gt+"/help",!1,!0),excludeWebSiteContextMenu:async(s,r)=>{let n=await o.getSettings(),l=$(I((await j()).activeTab.url));o.Yt(l,n)?await o.ne(l):await o.xe(l),await Q()}};chrome.contextMenus.onClicked.addListener(async(s,r)=>{await St();let n=s.menuItemId,[l]=n.split(":"),w;n.includes(":")&&(w=n.substring(n.indexOf(":")+1));let c=Object.entries(a).find(([h])=>h===l)?.[1];c?await c(s,r,w):console.log(`no action matched for menuItemId: ${n}`)}),le(),we(()=>Q()),ue()}async function me(){let i=await g().get("lastSeenVersion");if(String(wt)!==String(i)){await g().put("lastSeenVersion",wt);let t=await o.Ie();(await C(!1)).some(e=>!e.incognito)&&t.windowId&&new Date().getTime()-(t.updateDate||0)<1e3*60&&(await Promise.all((await M()).filter(s=>G(s.url)).map(s=>W(s))),(await C(!1)).find(s=>!s.incognito&&s.id===t.windowId)&&await o.He({windowId:t.windowId,index:t.index,url:u,active:!!t.active,pinned:!!t.pinned})),await o.oe({})}else{let t=await o.getSettings();(await o.getState()).tabGroups.map(s=>s.tabsMeta.length).reduce((s,r)=>s+r,0)>0&&E("startupLaunch",t)==="displayOneTab"&&((await C(!1)).find(s=>!s.incognito)?await o.Z(!0):chrome.windows.onCreated.addListener(async s=>{try{await o.ce.Pt(),await S().get("openOneTabOnStartTriggered")||(await C(!1)).find(r=>!r.incognito)&&(await S().put("openOneTabOnStartTriggered","true"),await o.Z(!0))}finally{o.ce.release()}}))}}function ye(){chrome.runtime.onMessage.addListener((i,t,e)=>{if(t.id===chrome.runtime.id&&i.L)return o[i.type]?o[i.type].constructor.name==="AsyncFunction"?(i.args&&(i.args=ft(i.args,Zt,void 0)),o[i.type](...i.args).then(a=>{e({result:a})}).catch(a=>{a.stack&&console.log(a.stack),e({P:a})}),!0):(e(o[i.type](...i.args)),!1):(e({P:"No such core method found"}),!1)})}async function Ne(){return;try{if(!await xe())return;await Promise.all((await M()).filter(i=>i.pinned&&!i.pendingUrl&&!i.url).map(async i=>{await W(i)}))}catch(i){console.log("cleanupSafariTabs exception"),console.log(i)}}async function xe(){return((await chrome.permissions.getAll())?.origins??[]).includes("*://*/*")}globalThis.populateWithTestData=async()=>{await o.Be(),console.log("populateWithTestData done")},globalThis.testRestoreOnVersionUpdate=async()=>{await o.Ve()},globalThis.runTestSuite=async i=>{await o.Ke(i)},globalThis.loopTestSuite=async(i,t)=>{await o.ze(i,t)};
